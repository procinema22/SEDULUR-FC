<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kolase Foto A4 Otomatis (Kiri Atas + Margin)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { font-family: sans-serif; text-align: center; margin: 20px; }
  canvas { border: 1px solid #ccc; margin-top: 10px; max-width: 90%; height: auto; background: white; }
  select, input, button { margin: 5px; padding: 6px 10px; font-size: 15px; }
</style>
</head>
<body>

<h2>KOLASE FOTO A4 OTOMATIS (Mulai dari Kiri Atas + Margin Cetak)</h2>

<label>Ukuran foto:</label>
<select id="photoSize">
  <option value="2x3">2x3 cm</option>
  <option value="3x4">3x4 cm</option>
  <option value="4x6">4x6 cm</option>
</select>

<label>Margin (mm):</label>
<input type="number" id="margin" value="5" min="0" max="20" style="width:60px">

<input type="file" id="fileInput" multiple accept="image/*">
<button id="generate">Buat Kolase</button>
<button id="download">Download PDF</button>

<canvas id="canvas" width="2480" height="3508"></canvas>
<p><small>A4 = 2480 × 3508 px @300 DPI</small></p>

<script>
const fileInput = document.getElementById("fileInput");
const generateBtn = document.getElementById("generate");
const downloadBtn = document.getElementById("download");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let pages = [];

const mmToPx = mm => Math.round(mm * 11.811); // konversi mm → pixel (300 DPI)

// Crop tengah supaya tidak gepeng
function drawImageCover(ctx, img, x, y, w, h) {
  const iw = img.width, ih = img.height;
  const ir = iw / ih, tr = w / h;
  let sx, sy, sw, sh;
  if (ir > tr) {
    sh = ih;
    sw = ih * tr;
    sx = (iw - sw) / 2;
    sy = 0;
  } else {
    sw = iw;
    sh = iw / tr;
    sx = 0;
    sy = (ih - sh) / 2;
  }
  ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
}

// Auto-rotate jika landscape
async function loadImageRotated(file) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      if (img.width > img.height) {
        const off = document.createElement("canvas");
        off.width = img.height;
        off.height = img.width;
        const octx = off.getContext("2d");
        octx.translate(off.width / 2, off.height / 2);
        octx.rotate(-Math.PI / 2);
        octx.drawImage(img, -img.width / 2, -img.height / 2);
        const rotated = new Image();
        rotated.onload = () => resolve(rotated);
        rotated.src = off.toDataURL("image/jpeg");
      } else {
        resolve(img);
      }
    };
    img.src = URL.createObjectURL(file);
  });
}

generateBtn.onclick = async () => {
  const size = document.getElementById("photoSize").value;
  const marginMM = parseFloat(document.getElementById("margin").value) || 0;
  const margin = mmToPx(marginMM);

  let [w, h] = size === "2x3" ? [20, 30] : size === "3x4" ? [30, 40] : [40, 60];
  const space = 2; // jarak antar foto dalam mm
  const imgW = mmToPx(w);
  const imgH = mmToPx(h);
  const gap = mmToPx(space);

  const files = [...fileInput.files];
  if (files.length === 0) return alert("Pilih foto terlebih dahulu.");

  const images = await Promise.all(files.map(loadImageRotated));

  pages = [];
  const usableW = canvas.width - margin * 2;
  const usableH = canvas.height - margin * 2;
  const cols = Math.floor((usableW + gap) / (imgW + gap));
  const rows = Math.floor((usableH + gap) / (imgH + gap));
  const perPage = cols * rows;
  const totalPages = Math.ceil(images.length / perPage);

  for (let p = 0; p < totalPages; p++) {
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const pageImgs = images.slice(p * perPage, (p + 1) * perPage);

    // posisi mulai kiri atas sesuai margin
    const startX = margin;
    const startY = margin;

    pageImgs.forEach((img, i) => {
      const col = i % cols;
      const row = Math.floor(i / cols);
      const x = startX + col * (imgW + gap);
      const y = startY + row * (imgH + gap);
      drawImageCover(ctx, img, x, y, imgW, imgH);
    });

    pages.push(canvas.toDataURL("image/jpeg", 1.0));
  }

  alert(`Kolase selesai dibuat (${pages.length} halaman).`);
};

downloadBtn.onclick = () => {
  if (pages.length === 0) return alert("Buat kolase dulu.");
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
  pages.forEach((img, i) => {
    if (i > 0) pdf.addPage();
    pdf.addImage(img, "JPEG", 0, 0, 210, 297);
  });
  pdf.save("kolase_foto_a4_kiriatas.pdf");
};
</script>

</body>
</html>
