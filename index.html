<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SEDULUR FOTOCOPY - Kolase Foto</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body {
    font-family: "Poppins", sans-serif;
    text-align: center;
    margin: 20px;
    background: var(--bg);
    color: var(--text);
    transition: background 0.3s, color 0.3s;
  }

  :root {
    --bg: #f4f7fb;
    --text: #333;
    --card: #fff;
  }

  body.dark {
    --bg: #121212;
    --text: #e0e0e0;
    --card: #1e1e1e;
  }

  canvas {
    border: 1px solid #ccc;
    margin-top: 10px;
    max-width: 90%;
    height: auto;
    background: white;
  }

  select, input, button {
    margin: 5px;
    padding: 6px 10px;
    font-size: 15px;
    border-radius: 6px;
  }

  button {
    background: #007bff;
    border: none;
    color: white;
    cursor: pointer;
    transition: 0.2s;
  }

  button:hover {
    background: #0056b3;
  }

  .option-group {
    margin: 10px 0;
  }

  .mode-toggle {
    position: fixed;
    top: 10px;
    right: 10px;
    background: var(--card);
    color: var(--text);
    border: 1px solid #888;
  }

  .copy-input {
    margin-top: 8px;
  }
</style>
</head>
<body>

<h2>üñ®Ô∏è SELAMAT DATANG DI SEDULUR FOTOCOPY</h2>
<button id="themeToggle" class="mode-toggle">üåó Ganti Mode</button>

<label>Nama pelanggan:</label>
<input type="text" id="customerName" placeholder="Masukkan nama" style="width:200px">
<br>

<label>Ukuran foto:</label>
<select id="photoSize">
  <option value="2x3">2x3 cm</option>
  <option value="3x4">3x4 cm</option>
  <option value="4x6">4x6 cm</option>
</select>

<label>Margin (mm):</label>
<input type="number" id="margin" value="5" min="0" max="20" style="width:60px">

<br>

<label>Pilih foto:</label>
<input type="file" id="fileInput" multiple accept="image/*">

<div class="option-group">
  <label><input type="radio" name="mode" value="normal" checked> Gunakan semua foto berbeda</label>
  <br>
  <label><input type="radio" name="mode" value="duplicate"> Gandakan foto yang sama di 1 lembar</label>

  <div class="copy-input" id="copyInputGroup">
    <label>Jumlah salinan per foto:</label>
    <input type="number" id="copyCount" value="4" min="1" max="100" style="width:70px">
  </div>
</div>

<button id="generate">Buat Kolase</button>
<button id="download">Download PDF</button>
<br><br>

<!-- üîπ Tambahkan kontrol printer -->
<select id="printerList">
  <option value="">(Memuat daftar printer...)</option>
</select>
<button id="autoPrint">üñ®Ô∏è Print Langsung</button>

<canvas id="canvas" width="2480" height="3508"></canvas>
<p><small>A4 = 2480 √ó 3508 px @300 DPI</small></p>

<script>
const fileInput = document.getElementById("fileInput");
const generateBtn = document.getElementById("generate");
const downloadBtn = document.getElementById("download");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const themeToggle = document.getElementById("themeToggle");
const autoPrintBtn = document.getElementById("autoPrint");
const printerList = document.getElementById("printerList");
let pages = [];

// üåó MODE GELAP
function applyThemeFromStorage() {
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme === "dark") {
    document.body.classList.add("dark");
    themeToggle.textContent = "‚òÄÔ∏è Mode Terang";
  } else {
    document.body.classList.remove("dark");
    themeToggle.textContent = "üåô Mode Gelap";
  }
}
applyThemeFromStorage();

themeToggle.onclick = () => {
  const isDark = document.body.classList.toggle("dark");
  localStorage.setItem("theme", isDark ? "dark" : "light");
  themeToggle.textContent = isDark ? "‚òÄÔ∏è Mode Terang" : "üåô Mode Gelap";
};

// Konversi mm ke pixel
const mmToPx = mm => Math.round(mm * 11.811);

// Fungsi crop agar gambar pas
function drawImageCover(ctx, img, x, y, w, h) {
  const iw = img.width, ih = img.height;
  const ir = iw / ih, tr = w / h;
  let sx, sy, sw, sh;
  if (ir > tr) {
    sh = ih;
    sw = ih * tr;
    sx = (iw - sw) / 2;
    sy = 0;
  } else {
    sw = iw;
    sh = iw / tr;
    sx = 0;
    sy = (ih - sh) / 2;
  }
  ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
}

// Rotasi otomatis
async function loadImageRotated(file) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      if (img.width > img.height) {
        const off = document.createElement("canvas");
        off.width = img.height;
        off.height = img.width;
        const octx = off.getContext("2d");
        octx.translate(off.width / 2, off.height / 2);
        octx.rotate(-Math.PI / 2);
        octx.drawImage(img, -img.width / 2, -img.height / 2);
        const rotated = new Image();
        rotated.onload = () => resolve(rotated);
        rotated.src = off.toDataURL("image/jpeg");
      } else {
        resolve(img);
      }
    };
    img.src = URL.createObjectURL(file);
  });
}

// Generate kolase
generateBtn.onclick = async () => {
  const size = document.getElementById("photoSize").value;
  const marginMM = parseFloat(document.getElementById("margin").value) || 0;
  const margin = mmToPx(marginMM);
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const copyCount = parseInt(document.getElementById("copyCount").value) || 1;
  const customerName = document.getElementById("customerName").value.trim() || "Tanpa Nama";

  let [w, h] = size === "2x3" ? [20, 30] : size === "3x4" ? [30, 40] : [40, 60];
  const space = 2;
  const imgW = mmToPx(w);
  const imgH = mmToPx(h);
  const gap = mmToPx(space);

  const files = [...fileInput.files];
  if (files.length === 0) return alert("Pilih foto terlebih dahulu.");

  const images = await Promise.all(files.map(loadImageRotated));

  pages = [];
  const usableW = canvas.width - margin * 2;
  const usableH = canvas.height - margin * 2;
  const cols = Math.floor((usableW + gap) / (imgW + gap));
  const rows = Math.floor((usableH + gap) / (imgH + gap));
  const perPage = cols * rows;

  let photoList = [];

  if (mode === "duplicate") {
    for (let i = 0; i < copyCount; i++) photoList.push(images[0]);
  } else {
    images.forEach(img => {
      for (let i = 0; i < copyCount; i++) {
        photoList.push(img);
      }
    });
  }

  const totalPages = Math.ceil(photoList.length / perPage);

  for (let p = 0; p < totalPages; p++) {
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Garis potong
    const cropLen = mmToPx(5);
    ctx.strokeStyle = "#888";
    ctx.lineWidth = 1;

    const drawCrop = (x, y) => {
      ctx.beginPath();
      ctx.moveTo(x - cropLen, y);
      ctx.lineTo(x, y);
      ctx.moveTo(x, y - cropLen);
      ctx.lineTo(x, y);
      ctx.stroke();
    };
    drawCrop(margin, margin);
    drawCrop(canvas.width - margin, margin);
    drawCrop(margin, canvas.height - margin);
    drawCrop(canvas.width - margin, canvas.height - margin);

    // Nama pelanggan
    ctx.font = "bold 60px Poppins";
    ctx.fillStyle = "black";
    const textWidth = ctx.measureText(customerName).width;
    const safeMargin = mmToPx(10);
    ctx.fillText(customerName, canvas.width - textWidth - safeMargin, canvas.height - safeMargin);

    // Gambar foto
    const pageImgs = photoList.slice(p * perPage, (p + 1) * perPage);
    const startX = margin;
    const startY = margin + 50;

    pageImgs.forEach((img, i) => {
      const col = i % cols;
      const row = Math.floor(i / cols);
      const x = startX + col * (imgW + gap);
      const y = startY + row * (imgH + gap);
      drawImageCover(ctx, img, x, y, imgW, imgH);
    });

    pages.push(canvas.toDataURL("image/jpeg", 1.0));
  }

  alert(`Kolase selesai dibuat (${pages.length} halaman).`);
};

// Download PDF
downloadBtn.onclick = () => {
  if (pages.length === 0) return alert("Buat kolase dulu.");
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
  pages.forEach((img, i) => {
    if (i > 0) pdf.addPage();
    pdf.addImage(img, "JPEG", 0, 0, 210, 297);
  });
  pdf.save("kolase_foto_a4.pdf");
};

// üîπ Ambil daftar printer dari server
async function loadPrinters() {
  try {
    const res = await fetch("http://localhost:3000/printers");
    const data = await res.json();
    printerList.innerHTML = data.map(p => `<option value="${p.name}">${p.name}</option>`).join("");
  } catch (e) {
    printerList.innerHTML = `<option value="">(Tidak ada printer ditemukan)</option>`;
  }
}
loadPrinters();

// üîπ Kirim hasil ke printer
autoPrintBtn.onclick = async () => {
  if (pages.length === 0) return alert("Buat kolase dulu.");
  const printerName = printerList.value;
  if (!printerName) return alert("Pilih printer terlebih dahulu.");

  const formData = new FormData();
  for (let i = 0; i < pages.length; i++) {
    const blob = await (await fetch(pages[i])).blob();
    formData.append("pages", blob, `page${i + 1}.jpg`);
  }

  const res = await fetch(`http://localhost:3000/print?printer=${encodeURIComponent(printerName)}`, {
    method: "POST",
    body: formData,
  });

  const msg = await res.text();
  alert(msg);
};
</script>

</body>
</html>
